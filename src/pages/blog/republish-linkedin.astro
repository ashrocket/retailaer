---
import { requireAuth } from '../../lib/auth';

export const prerender = false;

// Require authentication
const session = requireAuth(Astro.cookies);

if (!session) {
  return Astro.redirect('/blog/login');
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Import Article - Retailaer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Slim Header -->
  <header class="editor-header">
    <div class="header-left">
      <a href="/" class="logo">Retailaer</a>
      <span class="divider">|</span>
      <span class="page-title">Import Article</span>
    </div>
    <div class="header-actions">
      <a href="/blog/editor" class="btn-text">New Post</a>
      <a href="/blog/manage" class="btn-text">Manage</a>
      <div class="user-menu">
        {session.picture && <img src={session.picture} alt={session.name} class="avatar" />}
        <button class="btn-text" id="user-menu-btn">
          {session.name}
          <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor">
            <path d="M4 6l4 4 4-4z"/>
          </svg>
        </button>
        <div class="dropdown hidden" id="user-dropdown">
          <a href="/api/auth/logout">Logout</a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container">
    <div class="intro-section">
      <h1>Import Article</h1>
      <p class="subtitle">Import a LinkedIn post or press article and create a preview post that links to the original</p>
    </div>

    <!-- Step 1: Enter Article URL -->
    <div class="step-section" id="step-1">
      <div class="step-header">
        <div class="step-number">1</div>
        <h2>Enter Article URL</h2>
      </div>
      <div class="step-content">
        <!-- Source type tabs -->
        <div class="source-tabs">
          <button class="source-tab active" data-source="linkedin">
            <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
              <path d="M5 3c0 1.1-.7 2-2 2-1.2 0-2-.9-2-1.9C1 2 1.8 1 3 1s2 .9 2 2zM1 19h4V6H1v13zM14.6 6.2c-2.1 0-3.3 1.2-3.8 2h-.1l-.2-1.7H6.9c0 1.1.1 2.4.1 3.9V19h4v-7.1c0-.4 0-.7.1-1 .3-.7.8-1.6 1.9-1.6 1.4 0 2 1.2 2 2.8V19h4v-7.4c0-3.7-1.9-5.4-4.4-5.4z"/>
            </svg>
            LinkedIn
          </button>
          <button class="source-tab" data-source="press">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 22h16a2 2 0 002-2V4a2 2 0 00-2-2H8a2 2 0 00-2 2v16a2 2 0 01-2 2zm0 0a2 2 0 01-2-2v-9c0-1.1.9-2 2-2h2"/>
              <path d="M18 14h-8M18 18h-8M18 10h-8"/>
            </svg>
            Press Article
          </button>
        </div>

        <div class="form-group">
          <label for="article-url" id="url-label">LinkedIn Article or Post URL</label>
          <input
            type="url"
            id="article-url"
            placeholder="https://www.linkedin.com/pulse/..."
            class="url-input"
          />
          <p class="help-text" id="url-help">Paste the URL of your LinkedIn article or post</p>
        </div>

        <div class="form-group" id="screenshot-option">
          <label>
            <input type="checkbox" id="capture-screenshot" checked />
            Capture screenshot of the article
          </label>
          <p class="help-text">Takes a visual snapshot including images (LinkedIn only)</p>
        </div>

        <button id="fetch-btn" class="btn-primary">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 12a9 9 0 11-6.22-8.56"/>
            <path d="M21 3v6h-6"/>
          </svg>
          Fetch Article
        </button>

        <div id="loading-state" class="hidden">
          <div class="loading-spinner"></div>
          <p id="loading-text">Fetching article...</p>
        </div>
      </div>
    </div>

    <!-- Screenshot Approval (shown between Step 1 and Step 2 for press articles) -->
    <div class="step-section hidden" id="screenshot-approval">
      <div class="step-header">
        <div class="step-number">üì∏</div>
        <h2>Article Screenshot</h2>
      </div>
      <div class="step-content">
        <div id="screenshot-capturing" class="screenshot-capture-status">
          <div class="loading-spinner"></div>
          <p>Capturing screenshot of the article...</p>
        </div>
        <div id="screenshot-result" class="hidden">
          <div class="screenshot-approval-preview">
            <img id="screenshot-approval-image" alt="Article screenshot preview" />
          </div>
          <div class="screenshot-approval-actions">
            <button id="approve-screenshot-btn" class="btn-primary">Use This Screenshot</button>
            <button id="skip-screenshot-btn" class="btn-secondary">Skip Screenshot</button>
          </div>
        </div>
        <div id="screenshot-failed" class="hidden">
          <p class="screenshot-fail-msg">Could not capture screenshot ‚Äî proceeding without one.</p>
        </div>
      </div>
    </div>

    <!-- Step 2: Preview & Edit -->
    <div class="step-section hidden" id="step-2">
      <div class="step-header">
        <div class="step-number">2</div>
        <h2>Review & Customize Preview</h2>
      </div>
      <div class="step-content">
        <div class="preview-editor">
          <div class="form-grid">
            <div class="form-group">
              <label for="preview-title">Preview Title</label>
              <input
                type="text"
                id="preview-title"
                placeholder="Title for the preview post"
                maxlength="150"
              />
            </div>

            <div class="form-group full-width">
              <label for="preview-excerpt">Summary / Excerpt</label>
              <textarea
                id="preview-excerpt"
                placeholder="Short excerpt or summary (2-3 sentences)"
                rows="4"
              ></textarea>
              <p class="help-text">Brief description shown on the card and insights listing</p>
            </div>

            <div class="form-group full-width">
              <label for="preview-commentary">Your Commentary</label>
              <textarea
                id="preview-commentary"
                placeholder="Add your take on this article (optional)"
                rows="5"
              ></textarea>
              <p class="help-text">Your perspective or key takeaways ‚Äî shown in the full post above the link to the original</p>
            </div>

            <div class="form-group">
              <label for="preview-meta">Badge Type</label>
              <select id="preview-meta">
                <option value="ARTICLE">ARTICLE</option>
                <option value="LINKEDIN POST">LINKEDIN POST</option>
                <option value="PRESS">PRESS</option>
                <option value="NEWS">NEWS</option>
                <option value="THOUGHT LEADERSHIP">THOUGHT LEADERSHIP</option>
                <option value="INDUSTRY INSIGHTS">INDUSTRY INSIGHTS</option>
              </select>
            </div>

            <div class="form-group">
              <label for="preview-icon">Icon</label>
              <select id="preview-icon">
                <option value="plane">‚úàÔ∏è Plane</option>
                <option value="document">üìÑ Document</option>
                <option value="chart">üìä Chart</option>
                <option value="globe">üåê Globe</option>
                <option value="rocket">üöÄ Rocket</option>
              </select>
            </div>

            <div class="form-group full-width">
              <label for="preview-gradient">Card Gradient</label>
              <select id="preview-gradient">
                <option value="linear-gradient(135deg, #FFF5E6 0%, #FFE4CC 100%)">üü† Warm Orange</option>
                <option value="linear-gradient(135deg, #FFF9E6 0%, #FFEDB3 100%)">üü° Bright Yellow</option>
                <option value="linear-gradient(135deg, #E6F7FF 0%, #CCE7FF 100%)">üîµ Cool Blue</option>
                <option value="linear-gradient(135deg, #F0F7F7 0%, #D9ECEC 100%)">üü¢ Teal</option>
                <option value="linear-gradient(135deg, #F5E6FF 0%, #E6CCFF 100%)">üü£ Purple</option>
                <option value="linear-gradient(135deg, #FFE6F0 0%, #FFCCE0 100%)">ü©∑ Pink</option>
              </select>
            </div>

            <div class="form-group full-width">
              <label for="original-url">Original Article URL</label>
              <input
                type="url"
                id="original-url"
                readonly
                class="readonly-input"
              />
            </div>

            <div class="form-group full-width" id="screenshot-section">
              <label>Article Screenshot</label>
              <div id="screenshot-container" class="screenshot-container hidden">
                <img id="screenshot-image" alt="LinkedIn article screenshot" />
                <button type="button" id="remove-screenshot" class="btn-text-small">Remove Screenshot</button>
              </div>
              <p class="help-text">Screenshot will be shown in the preview post</p>
            </div>
          </div>

          <!-- Live Preview -->
          <div class="live-preview-section">
            <h3>Carousel Card Preview</h3>
            <div class="carousel-card-preview" id="carousel-card-preview">
              <div class="preview-icon" id="preview-icon-display">‚úàÔ∏è</div>
              <div class="preview-badge" id="preview-badge-display">ARTICLE</div>
              <h4 id="preview-title-display">Your article title</h4>
              <p id="preview-excerpt-display">Your preview excerpt will appear here...</p>
            </div>

            <h3 style="margin-top: 32px;">Full Post Preview</h3>
            <div class="full-post-preview">
              <h1 id="full-title-display">Article Title</h1>
              <div id="full-screenshot-display" class="screenshot-preview hidden">
                <img id="full-screenshot-image" alt="Article preview" />
              </div>
              <div id="full-excerpt-display" class="excerpt-content">
                <p>Your preview content will appear here...</p>
              </div>
              <a href="#" id="cta-preview" class="article-cta" target="_blank">
                <svg id="cta-icon-linkedin" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                  <path d="M5 3c0 1.1-.7 2-2 2-1.2 0-2-.9-2-1.9C1 2 1.8 1 3 1s2 .9 2 2zM1 19h4V6H1v13zM14.6 6.2c-2.1 0-3.3 1.2-3.8 2h-.1l-.2-1.7H6.9c0 1.1.1 2.4.1 3.9V19h4v-7.1c0-.4 0-.7.1-1 .3-.7.8-1.6 1.9-1.6 1.4 0 2 1.2 2 2.8V19h4v-7.4c0-3.7-1.9-5.4-4.4-5.4z"/>
                </svg>
                <svg id="cta-icon-press" class="hidden" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
                  <polyline points="15 3 21 3 21 9"/>
                  <line x1="10" y1="14" x2="21" y2="3"/>
                </svg>
                <span id="cta-text">Continue Reading on LinkedIn</span> ‚Üí
              </a>
            </div>
          </div>
        </div>

        <div class="action-buttons">
          <button id="back-btn" class="btn-secondary">‚Üê Back</button>
          <button id="create-preview-btn" class="btn-primary">Create Preview Post</button>
        </div>
      </div>
    </div>

    <!-- Step 3: Success -->
    <div class="step-section hidden" id="step-3">
      <div class="success-message">
        <svg width="64" height="64" viewBox="0 0 64 64" fill="none">
          <circle cx="32" cy="32" r="30" fill="#0a5c5c" opacity="0.1"/>
          <path d="M20 32l8 8 16-16" stroke="#0a5c5c" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h2>Preview Post Created!</h2>
        <p id="success-message">Your article preview has been published and will be live in 1-2 minutes.</p>
        <div id="success-link" class="hidden" style="margin-bottom: 24px;">
          <a id="success-post-url" href="#" target="_blank" class="btn-text" style="color: #0a5c5c; font-weight: 600;">View Post ‚Üí</a>
        </div>
        <div class="success-actions">
          <a href="/blog/manage" class="btn-primary">Go to Manage</a>
          <a href="/blog/republish-linkedin" class="btn-secondary">Import Another</a>
        </div>
      </div>
    </div>
  </div>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #fafafa;
      color: #1a1a1a;
    }

    /* Header */
    .editor-header {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      font-size: 18px;
      font-weight: 700;
      color: #0a5c5c;
      text-decoration: none;
      letter-spacing: -0.5px;
    }

    .divider {
      color: #e5e7eb;
    }

    .page-title {
      font-size: 14px;
      color: #6b7280;
      font-weight: 500;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .btn-text {
      background: none;
      border: none;
      color: #4b5563;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      text-decoration: none;
    }

    .btn-text:hover {
      background: #f0f7f7;
      color: #0a5c5c;
    }

    .user-menu {
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }

    .dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      min-width: 150px;
    }

    .dropdown a {
      display: block;
      padding: 12px 16px;
      color: #374151;
      text-decoration: none;
      font-size: 14px;
    }

    .dropdown a:hover {
      background: #f0f7f7;
      color: #0a5c5c;
    }

    .hidden {
      display: none !important;
    }

    /* Container */
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .intro-section {
      margin-bottom: 48px;
    }

    .intro-section h1 {
      font-size: 32px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 12px;
    }

    .subtitle {
      font-size: 16px;
      color: #6b7280;
      line-height: 1.6;
    }

    /* Step Sections */
    .step-section {
      background: white;
      border-radius: 12px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .step-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
    }

    .step-number {
      width: 40px;
      height: 40px;
      background: #0a5c5c;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
    }

    .step-header h2 {
      font-size: 24px;
      font-weight: 600;
      color: #1a1a1a;
    }

    .step-content {
      padding: 8px 0;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 24px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 8px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #0a5c5c;
      box-shadow: 0 0 0 3px rgba(10, 92, 92, 0.1);
    }

    .url-input {
      font-size: 16px;
    }

    .readonly-input {
      background: #f9fafb;
      color: #6b7280;
    }

    .help-text {
      font-size: 13px;
      color: #6b7280;
      margin-top: 6px;
    }

    .form-group label input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }

    /* Screenshot */
    .screenshot-container {
      position: relative;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      background: #f9fafb;
    }

    .screenshot-container img {
      width: 100%;
      height: auto;
      border-radius: 4px;
      margin-bottom: 12px;
    }

    .btn-text-small {
      background: #dc2626;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-text-small:hover {
      background: #b91c1c;
    }

    .screenshot-preview {
      margin: 24px 0;
    }

    .screenshot-preview img {
      width: 100%;
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    /* Loading */
    #loading-state {
      text-align: center;
      padding: 24px;
      color: #6b7280;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto 16px;
      border: 4px solid #e5e7eb;
      border-top-color: #0a5c5c;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 32px;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    /* Buttons */
    .btn-primary {
      background: #0a5c5c;
      color: white;
      border: none;
      padding: 12px 32px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      text-decoration: none;
    }

    .btn-primary:hover {
      background: #084a4f;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(10, 92, 92, 0.2);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: white;
      color: #0a5c5c;
      border: 2px solid #0a5c5c;
      padding: 12px 32px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
    }

    .btn-secondary:hover {
      background: #0a5c5c;
      color: white;
    }

    /* Preview */
    .live-preview-section {
      margin-top: 32px;
      padding-top: 32px;
      border-top: 2px solid #e5e7eb;
    }

    .live-preview-section h3 {
      font-size: 18px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 16px;
    }

    .carousel-card-preview {
      padding: 24px;
      border-radius: 12px;
      background: linear-gradient(135deg, #FFF5E6 0%, #FFE4CC 100%);
      max-width: 400px;
      transition: background 0.3s;
    }

    .preview-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .preview-badge {
      font-size: 11px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .carousel-card-preview h4 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #1a1a1a;
    }

    .carousel-card-preview p {
      font-size: 14px;
      line-height: 1.6;
      color: #374151;
    }

    .full-post-preview {
      background: #f9fafb;
      padding: 32px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }

    .full-post-preview h1 {
      font-size: 32px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 24px;
      line-height: 1.2;
    }

    .excerpt-content {
      font-size: 16px;
      line-height: 1.7;
      color: #374151;
      margin-bottom: 32px;
    }

    .excerpt-content p {
      margin-bottom: 16px;
    }

    /* Source type tabs */
    .source-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }

    .source-tab {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.2s;
    }

    .source-tab:hover {
      border-color: #0a5c5c;
      color: #0a5c5c;
    }

    .source-tab.active {
      background: #0a5c5c;
      border-color: #0a5c5c;
      color: white;
    }

    .source-tab svg {
      flex-shrink: 0;
    }

    .article-cta {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #0077b5;
      color: white;
      padding: 14px 28px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.2s;
    }

    .article-cta:hover {
      background: #005885;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 119, 181, 0.3);
    }

    .article-cta.press-cta {
      background: #0a5c5c;
    }

    .article-cta.press-cta:hover {
      background: #084a4f;
      box-shadow: 0 4px 12px rgba(10, 92, 92, 0.3);
    }

    .action-buttons {
      display: flex;
      gap: 16px;
      justify-content: flex-end;
      margin-top: 32px;
    }

    /* Success */
    .success-message {
      text-align: center;
      padding: 48px 24px;
    }

    .success-message svg {
      margin-bottom: 24px;
    }

    .success-message h2 {
      font-size: 28px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 12px;
    }

    .success-message p {
      font-size: 16px;
      color: #6b7280;
      margin-bottom: 32px;
    }

    .success-actions {
      display: flex;
      gap: 16px;
      justify-content: center;
    }

    /* Screenshot approval */
    .screenshot-capture-status {
      text-align: center;
      padding: 32px;
      color: #6b7280;
    }

    .screenshot-approval-preview {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 24px;
      max-height: 500px;
      overflow-y: auto;
    }

    .screenshot-approval-preview img {
      width: 100%;
      height: auto;
      display: block;
    }

    .screenshot-approval-actions {
      display: flex;
      gap: 16px;
      justify-content: center;
    }

    .screenshot-fail-msg {
      text-align: center;
      color: #6b7280;
      padding: 24px;
      font-style: italic;
    }

    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }

      .step-section {
        padding: 24px 16px;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .action-buttons {
        flex-direction: column-reverse;
      }

      .success-actions {
        flex-direction: column;
      }

      .full-post-preview {
        padding: 20px;
      }
    }
  </style>

  <script>
    // ‚îÄ‚îÄ State ‚îÄ‚îÄ
    let sourceType: 'linkedin' | 'press' = 'linkedin';
    let screenshotDataUrl: string | null = null;
    let ogImageUrl: string | null = null;

    const iconMap: Record<string, string> = {
      'plane': '‚úàÔ∏è',
      'document': 'üìÑ',
      'chart': 'üìä',
      'globe': 'üåê',
      'rocket': 'üöÄ'
    };

    // ‚îÄ‚îÄ User dropdown ‚îÄ‚îÄ
    const userMenuBtn = document.getElementById('user-menu-btn');
    const userDropdown = document.getElementById('user-dropdown');
    userMenuBtn?.addEventListener('click', () => userDropdown?.classList.toggle('hidden'));
    document.addEventListener('click', (e) => {
      if (!userMenuBtn?.contains(e.target as Node) && !userDropdown?.contains(e.target as Node)) {
        userDropdown?.classList.add('hidden');
      }
    });

    // ‚îÄ‚îÄ Source type tabs ‚îÄ‚îÄ
    document.querySelectorAll('.source-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.source-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        sourceType = (tab as HTMLElement).dataset.source as 'linkedin' | 'press';
        updateStep1ForSource();
      });
    });

    function updateStep1ForSource() {
      const urlInput = document.getElementById('article-url') as HTMLInputElement;
      const urlLabel = document.getElementById('url-label');
      const urlHelp = document.getElementById('url-help');
      const screenshotOption = document.getElementById('screenshot-option');

      if (sourceType === 'press') {
        if (urlLabel) urlLabel.textContent = 'Article URL';
        if (urlInput) urlInput.placeholder = 'https://www.example.com/article/...';
        if (urlHelp) urlHelp.textContent = 'Paste the URL of the press article or news story';
        screenshotOption?.classList.add('hidden');
      } else {
        if (urlLabel) urlLabel.textContent = 'LinkedIn Article or Post URL';
        if (urlInput) urlInput.placeholder = 'https://www.linkedin.com/pulse/...';
        if (urlHelp) urlHelp.textContent = 'Paste the URL of your LinkedIn article or post';
        screenshotOption?.classList.remove('hidden');
      }
    }

    // ‚îÄ‚îÄ Fetch article ‚îÄ‚îÄ
    const fetchBtn = document.getElementById('fetch-btn');
    const loadingState = document.getElementById('loading-state');

    fetchBtn?.addEventListener('click', async () => {
      const urlInput = document.getElementById('article-url') as HTMLInputElement;
      const url = urlInput?.value?.trim();

      if (!url) {
        alert('Please enter a URL');
        return;
      }

      // Validate: LinkedIn mode requires linkedin.com, press mode accepts any URL
      if (sourceType === 'linkedin' && !url.includes('linkedin.com')) {
        alert('Please enter a valid LinkedIn URL');
        return;
      }

      if (!url.startsWith('http')) {
        alert('Please enter a valid URL starting with http:// or https://');
        return;
      }

      try {
        if (fetchBtn) (fetchBtn as HTMLButtonElement).disabled = true;
        loadingState?.classList.remove('hidden');
        const loadingText = document.getElementById('loading-text');

        if (sourceType === 'press') {
          // Use fetch-article API for press articles
          if (loadingText) loadingText.textContent = 'Fetching article metadata...';

          const response = await fetch('/api/fetch-article', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
          });

          if (!response.ok) {
            const err = await response.json().catch(() => ({}));
            throw new Error(err.error || 'Failed to fetch article');
          }

          const data = await response.json();
          const title = data.title || 'Untitled Article';
          const description = data.description || '';
          ogImageUrl = data.image || null;

          // Populate form
          (document.getElementById('preview-title') as HTMLInputElement).value = title;
          (document.getElementById('preview-excerpt') as HTMLTextAreaElement).value = description;
          (document.getElementById('original-url') as HTMLInputElement).value = url;

          // Default badge to PRESS for press articles
          const metaSelect = document.getElementById('preview-meta') as HTMLSelectElement;
          if (metaSelect) metaSelect.value = 'PRESS';

          // Hide loading, show screenshot approval step
          loadingState?.classList.add('hidden');
          if (fetchBtn) (fetchBtn as HTMLButtonElement).disabled = false;
          document.getElementById('step-1')?.classList.add('hidden');
          document.getElementById('screenshot-approval')?.classList.remove('hidden');

          // Attempt screenshot capture from bodyHtml
          attemptScreenshotCapture(data.bodyHtml);

          // Update previews and CTA (will be applied when Step 2 is shown)
          updateCtaStyle();
          updatePreviews();
          return; // Flow continues via approval buttons

        } else {
          // LinkedIn mode: use screenshot API
          if (loadingText) loadingText.textContent = 'Capturing article screenshot...';
          const captureScreenshot = (document.getElementById('capture-screenshot') as HTMLInputElement)?.checked;

          const response = await fetch('/api/screenshot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url })
          });

          if (!response.ok) throw new Error('Failed to fetch article');

          const data = await response.json();
          if (captureScreenshot && data.screenshot) {
            screenshotDataUrl = data.screenshot;
          }

          const title = data.title || 'LinkedIn Article';
          const content = data.content || '';
          const paragraphs = content.split('\n\n').filter((p: string) => p.length > 50);
          const excerpt = paragraphs.slice(0, 3).join('\n\n');

          (document.getElementById('preview-title') as HTMLInputElement).value = title;
          (document.getElementById('preview-excerpt') as HTMLTextAreaElement).value = excerpt || content.substring(0, 500);
          (document.getElementById('original-url') as HTMLInputElement).value = url;

          if (screenshotDataUrl) {
            const screenshotContainer = document.getElementById('screenshot-container');
            const screenshotImage = document.getElementById('screenshot-image') as HTMLImageElement;
            const fullScreenshotDisplay = document.getElementById('full-screenshot-display');
            const fullScreenshotImage = document.getElementById('full-screenshot-image') as HTMLImageElement;

            if (screenshotImage && screenshotContainer) {
              screenshotImage.src = screenshotDataUrl;
              screenshotContainer.classList.remove('hidden');
            }
            if (fullScreenshotImage && fullScreenshotDisplay) {
              fullScreenshotImage.src = screenshotDataUrl;
              fullScreenshotDisplay.classList.remove('hidden');
            }
          }
        }

        // Update CTA style based on source type
        updateCtaStyle();
        updatePreviews();

        loadingState?.classList.add('hidden');
        if (fetchBtn) (fetchBtn as HTMLButtonElement).disabled = false;

        document.getElementById('step-1')?.classList.add('hidden');
        document.getElementById('step-2')?.classList.remove('hidden');

      } catch (error) {
        console.error('Error fetching article:', error);
        alert(error instanceof Error ? error.message : 'Failed to fetch article. Please try again.');
        loadingState?.classList.add('hidden');
        if (fetchBtn) (fetchBtn as HTMLButtonElement).disabled = false;
      }
    });

    // ‚îÄ‚îÄ CTA style ‚îÄ‚îÄ
    function updateCtaStyle() {
      const cta = document.getElementById('cta-preview');
      const ctaText = document.getElementById('cta-text');
      const linkedinIcon = document.getElementById('cta-icon-linkedin');
      const pressIcon = document.getElementById('cta-icon-press');

      if (sourceType === 'press') {
        cta?.classList.add('press-cta');
        if (ctaText) ctaText.textContent = 'Read Original Article';
        linkedinIcon?.classList.add('hidden');
        pressIcon?.classList.remove('hidden');
      } else {
        cta?.classList.remove('press-cta');
        if (ctaText) ctaText.textContent = 'Continue Reading on LinkedIn';
        linkedinIcon?.classList.remove('hidden');
        pressIcon?.classList.add('hidden');
      }
    }

    // ‚îÄ‚îÄ Live preview updates ‚îÄ‚îÄ
    // Note: This page is behind authentication ‚Äî only logged-in editors can
    // reach it, and the preview content comes from their own form inputs.
    function updatePreviews() {
      const title = (document.getElementById('preview-title') as HTMLInputElement)?.value || 'Your article title';
      const excerpt = (document.getElementById('preview-excerpt') as HTMLTextAreaElement)?.value || 'Your preview excerpt will appear here...';
      const commentary = (document.getElementById('preview-commentary') as HTMLTextAreaElement)?.value || '';
      const meta = (document.getElementById('preview-meta') as HTMLSelectElement)?.value || 'ARTICLE';
      const icon = (document.getElementById('preview-icon') as HTMLSelectElement)?.value || 'plane';
      const gradient = (document.getElementById('preview-gradient') as HTMLSelectElement)?.value;
      const articleUrl = (document.getElementById('original-url') as HTMLInputElement)?.value;

      // Update carousel card
      const carouselCard = document.getElementById('carousel-card-preview');
      const previewTitleDisplay = document.getElementById('preview-title-display');
      const previewExcerptDisplay = document.getElementById('preview-excerpt-display');
      const previewBadgeDisplay = document.getElementById('preview-badge-display');
      const previewIconDisplay = document.getElementById('preview-icon-display');

      if (previewTitleDisplay) previewTitleDisplay.textContent = title;
      if (previewExcerptDisplay) previewExcerptDisplay.textContent = excerpt.substring(0, 150) + (excerpt.length > 150 ? '...' : '');
      if (previewBadgeDisplay) previewBadgeDisplay.textContent = meta;
      if (previewIconDisplay) previewIconDisplay.textContent = iconMap[icon] || '‚úàÔ∏è';
      if (carouselCard && gradient) carouselCard.style.background = gradient;

      // Update full post preview ‚Äî content authored by authenticated editor
      const fullTitleDisplay = document.getElementById('full-title-display');
      const fullExcerptDisplay = document.getElementById('full-excerpt-display');
      const ctaPreview = document.getElementById('cta-preview') as HTMLAnchorElement;

      if (fullTitleDisplay) fullTitleDisplay.textContent = title;
      if (fullExcerptDisplay) {
        // Build preview paragraphs from editor's own text
        const excerptParas = excerpt.split('\n').filter(Boolean);
        const commentaryParas = commentary ? commentary.split('\n').filter(Boolean) : [];

        // Clear existing content and build with DOM methods
        fullExcerptDisplay.textContent = '';
        excerptParas.forEach(text => {
          const p = document.createElement('p');
          p.textContent = text;
          fullExcerptDisplay.appendChild(p);
        });
        if (commentaryParas.length > 0) {
          const hr = document.createElement('hr');
          hr.style.cssText = 'margin: 24px 0; border: none; border-top: 1px solid #e5e7eb;';
          fullExcerptDisplay.appendChild(hr);
          commentaryParas.forEach(text => {
            const p = document.createElement('p');
            const em = document.createElement('em');
            em.textContent = text;
            p.appendChild(em);
            fullExcerptDisplay.appendChild(p);
          });
        }
      }
      if (ctaPreview && articleUrl) ctaPreview.href = articleUrl;
    }

    // Attach live-update listeners
    ['preview-title', 'preview-excerpt', 'preview-commentary'].forEach(id => {
      document.getElementById(id)?.addEventListener('input', updatePreviews);
    });
    ['preview-meta', 'preview-icon', 'preview-gradient'].forEach(id => {
      document.getElementById(id)?.addEventListener('change', updatePreviews);
    });

    // ‚îÄ‚îÄ Back button ‚îÄ‚îÄ
    document.getElementById('back-btn')?.addEventListener('click', () => {
      document.getElementById('step-2')?.classList.add('hidden');
      document.getElementById('step-1')?.classList.remove('hidden');
    });

    // ‚îÄ‚îÄ Remove screenshot/image ‚îÄ‚îÄ
    document.getElementById('remove-screenshot')?.addEventListener('click', () => {
      screenshotDataUrl = null;
      ogImageUrl = null;
      document.getElementById('screenshot-container')?.classList.add('hidden');
      document.getElementById('full-screenshot-display')?.classList.add('hidden');
    });

    // ‚îÄ‚îÄ Create preview post (real publish) ‚îÄ‚îÄ
    document.getElementById('create-preview-btn')?.addEventListener('click', async () => {
      const title = (document.getElementById('preview-title') as HTMLInputElement)?.value;
      const excerpt = (document.getElementById('preview-excerpt') as HTMLTextAreaElement)?.value;
      const commentary = (document.getElementById('preview-commentary') as HTMLTextAreaElement)?.value || '';
      const articleUrl = (document.getElementById('original-url') as HTMLInputElement)?.value;
      const meta = (document.getElementById('preview-meta') as HTMLSelectElement)?.value;
      const icon = (document.getElementById('preview-icon') as HTMLSelectElement)?.value;
      const gradient = (document.getElementById('preview-gradient') as HTMLSelectElement)?.value;

      if (!title || !articleUrl) {
        alert('Please fill in at least the title and article URL');
        return;
      }

      const createBtn = document.getElementById('create-preview-btn') as HTMLButtonElement;
      if (createBtn) {
        createBtn.disabled = true;
        createBtn.textContent = 'Publishing...';
      }

      try {
        // Build the post content HTML
        const ctaLabel = sourceType === 'press' ? 'Read Original Article' : 'Continue Reading on LinkedIn';
        let contentParts: string[] = [];
        if (excerpt) {
          contentParts.push(...excerpt.split('\n').filter(Boolean).map(p => '<p>' + p + '</p>'));
        }
        if (commentary) {
          contentParts.push('<hr>');
          contentParts.push(...commentary.split('\n').filter(Boolean).map(p => '<p>' + p + '</p>'));
        }
        contentParts.push('<p><a href="' + articleUrl + '" target="_blank" rel="noopener">' + ctaLabel + ' ‚Üí</a></p>');
        const contentHtml = contentParts.join('\n');

        // Generate slug from title
        const slug = title
          .toLowerCase()
          .replace(/[^a-z0-9\s-]/g, '')
          .replace(/\s+/g, '-')
          .replace(/-+/g, '-')
          .replace(/^-|-$/g, '')
          .substring(0, 60);

        const coverImage = ogImageUrl || undefined;

        const response = await fetch('/api/blog/publish', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title,
            slug,
            content: contentHtml,
            excerpt: excerpt || title,
            status: 'published',
            coverImage,
            carouselPreview: {
              title,
              excerpt: excerpt || title,
              meta: meta || 'ARTICLE',
              icon: icon || 'plane',
              backgroundGradient: gradient,
            },
          })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'Failed to publish');
        }

        // Show success with link
        const successMsg = document.getElementById('success-message');
        const successLink = document.getElementById('success-link');
        const successPostUrl = document.getElementById('success-post-url') as HTMLAnchorElement;

        if (successMsg) {
          successMsg.textContent = result.message || 'Your article preview has been published!';
        }
        if (result.post?.url && successLink && successPostUrl) {
          successPostUrl.href = result.post.url;
          successPostUrl.textContent = result.post.url;
          successLink.classList.remove('hidden');
        }

        document.getElementById('step-2')?.classList.add('hidden');
        document.getElementById('step-3')?.classList.remove('hidden');

      } catch (error) {
        console.error('Publish error:', error);
        alert(error instanceof Error ? error.message : 'Failed to publish. Please try again.');
        if (createBtn) {
          createBtn.disabled = false;
          createBtn.textContent = 'Create Preview Post';
        }
      }
    });
    // ‚îÄ‚îÄ Screenshot capture for press articles ‚îÄ‚îÄ
    async function attemptScreenshotCapture(bodyHtml: string | null) {
      const capturingEl = document.getElementById('screenshot-capturing');
      const resultEl = document.getElementById('screenshot-result');
      const failedEl = document.getElementById('screenshot-failed');

      if (!bodyHtml) {
        // No body HTML available ‚Äî auto-skip after brief pause
        if (capturingEl) capturingEl.classList.add('hidden');
        if (failedEl) failedEl.classList.remove('hidden');
        setTimeout(() => proceedToStep2(), 1500);
        return;
      }

      try {
        const html2canvas = (await import('html2canvas')).default;

        // Create hidden iframe
        const iframe = document.createElement('iframe');
        iframe.style.cssText = 'position:fixed;left:-9999px;top:0;width:1200px;height:2000px;border:none;';
        iframe.sandbox.add('allow-same-origin'); // needed for html2canvas to read DOM
        document.body.appendChild(iframe);

        // Write content via srcdoc
        iframe.srcdoc = bodyHtml;

        await new Promise<void>((resolve, reject) => {
          iframe.onload = () => resolve();
          iframe.onerror = () => reject(new Error('Iframe failed to load'));
          setTimeout(() => resolve(), 8000); // safety timeout
        });

        // Wait for external resources (images, CSS) to settle
        await new Promise(r => setTimeout(r, 2500));

        const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
        if (!iframeDoc?.body) throw new Error('Cannot access iframe document');

        const canvas = await html2canvas(iframeDoc.body, {
          allowTaint: true,
          useCORS: true,
          scale: 0.8,
          windowWidth: 1200,
          windowHeight: 2000,
          width: 1200,
          height: Math.min(iframeDoc.body.scrollHeight, 2000),
        });

        // Cleanup iframe
        document.body.removeChild(iframe);

        const dataUrl = canvas.toDataURL('image/jpeg', 0.8);

        // Show approval UI
        if (capturingEl) capturingEl.classList.add('hidden');
        const previewImg = document.getElementById('screenshot-approval-image') as HTMLImageElement;
        if (previewImg) previewImg.src = dataUrl;
        if (resultEl) resultEl.classList.remove('hidden');

        // Store temporarily ‚Äî approval handler will use it
        (window as any).__pendingScreenshot = dataUrl;

      } catch (err) {
        console.error('Screenshot capture failed:', err);
        // Remove iframe if it's still around
        const leftoverIframe = document.querySelector('iframe[style*="-9999px"]');
        if (leftoverIframe) leftoverIframe.remove();

        if (capturingEl) capturingEl.classList.add('hidden');
        if (failedEl) failedEl.classList.remove('hidden');
        setTimeout(() => proceedToStep2(), 1500);
      }
    }

    function proceedToStep2() {
      document.getElementById('screenshot-approval')?.classList.add('hidden');
      document.getElementById('step-2')?.classList.remove('hidden');
    }

    function applyScreenshotToPreview(dataUrl: string) {
      ogImageUrl = dataUrl;

      const screenshotContainer = document.getElementById('screenshot-container');
      const screenshotImage = document.getElementById('screenshot-image') as HTMLImageElement;
      const fullScreenshotDisplay = document.getElementById('full-screenshot-display');
      const fullScreenshotImage = document.getElementById('full-screenshot-image') as HTMLImageElement;

      if (screenshotImage && screenshotContainer) {
        screenshotImage.src = dataUrl;
        screenshotImage.alt = 'Article screenshot';
        screenshotContainer.classList.remove('hidden');
      }
      if (fullScreenshotImage && fullScreenshotDisplay) {
        fullScreenshotImage.src = dataUrl;
        fullScreenshotDisplay.classList.remove('hidden');
      }
    }

    // Approval buttons
    document.getElementById('approve-screenshot-btn')?.addEventListener('click', () => {
      const dataUrl = (window as any).__pendingScreenshot;
      if (dataUrl) {
        applyScreenshotToPreview(dataUrl);
        delete (window as any).__pendingScreenshot;
      }
      proceedToStep2();
    });

    document.getElementById('skip-screenshot-btn')?.addEventListener('click', () => {
      delete (window as any).__pendingScreenshot;
      proceedToStep2();
    });
  </script>
</body>
</html>
