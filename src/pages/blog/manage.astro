---
import { requireAuth } from '../../lib/auth';

export const prerender = false;

// Require authentication
const session = requireAuth(Astro.cookies);

if (!session) {
  return Astro.redirect('/blog/login');
}

// Load real posts from content directory (Cloudflare Workers compatible)
const blogModules = import.meta.glob('../../content/blog/*.json', { eager: true });

const posts = Object.values(blogModules)
  .map((module: any) => {
    const data = module.default || module;
    // Use id if present, otherwise fall back to slug for older posts
    return data ? { ...data, id: data.id || data.slug } : null;
  })
  .filter(post => post !== null)
  .sort((a, b) => new Date(b.updatedAt || b.createdAt).getTime() - new Date(a.updatedAt || a.createdAt).getTime());
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Insights & Articles - Retailaer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Slim Header -->
  <header class="editor-header">
    <div class="header-left">
      <a href="/" class="logo">Retailaer</a>
      <span class="divider">|</span>
      <span class="page-title">Manage Insights</span>
    </div>
    <div class="header-actions">
      <a href="/blog/editor" class="btn-text">New Post</a>
      <a href="/blog/republish-linkedin" class="btn-text">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path d="M3.5 2c0 .6-.4 1-1 1s-1-.4-1-1 .4-1 1-1 1 .4 1 1zM1 14h3V5H1v9zm9.3-9c-1.1 0-1.7.6-1.9 1h-.1l-.1-.9H5.5v.5c0 .6 0 1.2 0 1.9V14h3V9.5c0-.2 0-.4 0-.5.2-.4.5-.8 1-.8.7 0 1 .6 1 1.4V14h3v-3.7c0-1.9-1-2.8-2.2-2.8z"/>
        </svg>
        Import from LinkedIn
      </a>
      <div class="user-menu">
        {session.picture && <img src={session.picture} alt={session.name} class="avatar" />}
        <button class="btn-text" id="user-menu-btn">
          {session.name}
          <svg width="12" height="12" viewBox="0 0 16 16" fill="currentColor">
            <path d="M4 6l4 4 4-4z"/>
          </svg>
        </button>
        <div class="dropdown hidden" id="user-dropdown">
          <a href="/api/auth/logout">Logout</a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="container">
    <div class="page-header">
      <div>
        <h1>Insights & Articles</h1>
        <p class="subtitle">Manage carousel order, visibility, and preview appearance</p>
      </div>
      <div class="carousel-settings">
        <label>
          <span>Auto-rotate</span>
          <input type="number" id="rotate-interval" value="15" min="5" max="60" />
          <span>seconds</span>
        </label>
        <label>
          <span>Visible cards</span>
          <input type="number" id="visible-count" value="3" min="1" max="6" />
        </label>
      </div>
    </div>

    <!-- Posts List -->
    <div class={`insights-list ${posts.length === 0 ? 'hidden' : ''}`} id="insights-list">
      {posts.map((post) => (
        <div class="insight-item" data-id={post.id} data-status={post.status}>
          <div class="drag-handle">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <circle cx="6" cy="5" r="1.5"/>
              <circle cx="6" cy="10" r="1.5"/>
              <circle cx="6" cy="15" r="1.5"/>
              <circle cx="14" cy="5" r="1.5"/>
              <circle cx="14" cy="10" r="1.5"/>
              <circle cx="14" cy="15" r="1.5"/>
            </svg>
          </div>

          <div class="insight-info">
            <div class="insight-header">
              <div>
                <h3>{post.title}</h3>
                <div class="insight-meta-row">
                  <span class={`status-badge ${post.status}`}>
                    {post.status === 'published' ? '‚úì Published' : 'üìù Draft'}
                  </span>
                  <span class="date">
                    {new Date(post.updatedAt || post.createdAt).toLocaleDateString('en-US', {
                      year: 'numeric',
                      month: 'short',
                      day: 'numeric'
                    })}
                  </span>
                  <span class="author">{post.author}</span>
                </div>
              </div>
              <div class="insight-actions">
                {post.status === 'published' ? (
                  <a href={`/blog/${post.slug}`} class="btn-text" target="_blank">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                      <polyline points="15 3 21 3 21 9"/>
                      <line x1="10" y1="14" x2="21" y2="3"/>
                    </svg>
                    View
                  </a>
                ) : (
                  <a href={`/blog/draft/${post.id}`} class="btn-text" target="_blank">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                      <circle cx="12" cy="12" r="3"/>
                    </svg>
                    Preview
                  </a>
                )}
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="post-actions">
              <button class="btn-text" data-id={post.id} data-action="edit">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                Edit
              </button>
              {post.status === 'published' ? (
                <button class="btn-text btn-warning" data-id={post.id} data-action="unpublish">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                  </svg>
                  Unpublish
                </button>
              ) : (
                <button class="btn-text btn-success" data-id={post.id} data-action="publish">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                  </svg>
                  Publish
                </button>
              )}
              <button class="btn-text btn-copy" data-id={post.id} data-action="copy-link" data-slug={post.slug} data-status={post.status}>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                </svg>
                Copy Link
              </button>
              <button class="btn-text text-danger" data-id={post.id} data-action="delete" data-title={post.title}>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
                Delete
              </button>
            </div>
          </div>
        </div>
      ))}
    </div>

    <div class={`empty-state ${posts.length > 0 ? 'hidden' : ''}`} id="empty-state">
      <svg width="120" height="120" viewBox="0 0 120 120" fill="none">
        <circle cx="60" cy="60" r="50" fill="#f0f7f7"/>
        <path d="M40 60h40M60 40v40" stroke="#0a5c5c" stroke-width="4" stroke-linecap="round"/>
      </svg>
      <h3>No insights yet</h3>
      <p>Create your first blog post or article to get started</p>
      <a href="/blog/editor" class="btn-primary">Create Post</a>
    </div>
  </div>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #fafafa;
      color: #1a1a1a;
    }

    /* Header */
    .editor-header {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      font-size: 18px;
      font-weight: 700;
      color: #0a5c5c;
      text-decoration: none;
      letter-spacing: -0.5px;
    }

    .divider {
      color: #e5e7eb;
    }

    .page-title {
      font-size: 14px;
      color: #6b7280;
      font-weight: 500;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .btn-text {
      background: none;
      border: none;
      color: #4b5563;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      text-decoration: none;
    }

    .btn-text:hover {
      background: #f0f7f7;
      color: #0a5c5c;
    }

    .btn-primary {
      background: #0a5c5c;
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary:hover {
      background: #084a4f;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(10, 92, 92, 0.2);
    }

    .user-menu {
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }

    .dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      min-width: 150px;
    }

    .dropdown a {
      display: block;
      padding: 12px 16px;
      color: #374151;
      text-decoration: none;
      font-size: 14px;
    }

    .dropdown a:hover {
      background: #f0f7f7;
      color: #0a5c5c;
    }

    .hidden {
      display: none !important;
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .page-header h1 {
      font-size: 32px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 16px;
      color: #6b7280;
    }

    .carousel-settings {
      display: flex;
      gap: 24px;
      background: white;
      padding: 16px 24px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    .carousel-settings label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #374151;
    }

    .carousel-settings input[type="number"] {
      width: 60px;
      padding: 6px 8px;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      font-size: 14px;
      text-align: center;
    }

    /* Insights List */
    .insights-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .insight-item {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      display: flex;
      gap: 16px;
      transition: all 0.2s;
      cursor: move;
    }

    .insight-item:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      border-color: #0a5c5c;
    }

    .insight-item.dragging {
      opacity: 0.5;
    }

    .drag-handle {
      color: #9ca3af;
      cursor: grab;
      padding: 4px;
    }

    .drag-handle:active {
      cursor: grabbing;
    }

    .insight-info {
      flex: 1;
    }

    .insight-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }

    .insight-header h3 {
      font-size: 18px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 8px;
    }

    .insight-meta-row {
      display: flex;
      gap: 12px;
      align-items: center;
      font-size: 13px;
      color: #6b7280;
    }

    .badge {
      background: #f0f7f7;
      color: #0a5c5c;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .date, .author {
      font-size: 13px;
    }

    .insight-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* Toggle Switch */
    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .toggle input {
      display: none;
    }

    .toggle-slider {
      width: 44px;
      height: 24px;
      background: #d1d5db;
      border-radius: 12px;
      position: relative;
      transition: background 0.2s;
    }

    .toggle-slider::before {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: transform 0.2s;
    }

    .toggle input:checked + .toggle-slider {
      background: #0a5c5c;
    }

    .toggle input:checked + .toggle-slider::before {
      transform: translateX(20px);
    }

    .toggle-label {
      font-size: 13px;
      font-weight: 500;
      color: #6b7280;
    }

    /* Preview Section */
    .preview-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #f3f4f6;
    }

    .preview-toggle {
      background: none;
      border: none;
      color: #0a5c5c;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 0;
      transition: opacity 0.2s;
    }

    .preview-toggle:hover {
      opacity: 0.7;
    }

    .preview-toggle svg {
      transition: transform 0.2s;
    }

    .preview-toggle.active svg {
      transform: rotate(180deg);
    }

    .preview-details {
      margin-top: 16px;
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 24px;
    }

    .preview-card-demo {
      padding: 24px;
      border-radius: 12px;
      min-height: 200px;
    }

    .demo-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .demo-meta {
      font-size: 11px;
      font-weight: 600;
      color: #6b7280;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .preview-card-demo h4 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #1a1a1a;
    }

    .preview-card-demo p {
      font-size: 14px;
      line-height: 1.6;
      color: #374151;
    }

    .preview-controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: start;
    }

    .text-danger {
      color: #dc2626 !important;
    }

    .text-danger:hover {
      background: #fee2e2 !important;
    }

    .btn-warning {
      color: #d97706 !important;
    }

    .btn-warning:hover {
      background: #fef3c7 !important;
    }

    .btn-success {
      color: #059669 !important;
    }

    .btn-success:hover {
      background: #d1fae5 !important;
    }

    .btn-copy:hover {
      background: #e0e7ff !important;
      color: #4338ca !important;
    }

    /* Status badge */
    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-badge.published {
      background: #d1fae5;
      color: #059669;
    }

    .status-badge.draft {
      background: #fef3c7;
      color: #d97706;
    }

    /* Post actions row */
    .post-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #f3f4f6;
    }

    /* Loading state */
    .btn-text.loading {
      opacity: 0.6;
      pointer-events: none;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #1f2937;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 10000;
      animation: slideIn 0.3s ease;
    }

    .toast.success {
      background: #059669;
    }

    .toast.error {
      background: #dc2626;
    }

    @keyframes slideIn {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 24px;
    }

    .empty-state h3 {
      font-size: 24px;
      font-weight: 600;
      margin: 24px 0 8px;
      color: #1a1a1a;
    }

    .empty-state p {
      font-size: 16px;
      color: #6b7280;
      margin-bottom: 24px;
    }

    @media (max-width: 768px) {
      .page-header {
        flex-direction: column;
        gap: 16px;
        align-items: start;
      }

      .carousel-settings {
        flex-direction: column;
        gap: 12px;
      }

      .preview-details {
        grid-template-columns: 1fr;
      }

      .insight-item {
        flex-direction: column;
      }

      .drag-handle {
        display: none;
      }
    }
  </style>

  <script>
    // User dropdown
    const userMenuBtn = document.getElementById('user-menu-btn');
    const userDropdown = document.getElementById('user-dropdown');

    userMenuBtn?.addEventListener('click', () => {
      userDropdown?.classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
      if (!userMenuBtn?.contains(e.target as Node) && !userDropdown?.contains(e.target as Node)) {
        userDropdown?.classList.add('hidden');
      }
    });

    // Preview toggle
    document.querySelectorAll('.preview-toggle').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = (e.currentTarget as HTMLElement).dataset.id;
        const details = document.querySelector(`.preview-details[data-id="${id}"]`);
        details?.classList.toggle('hidden');
        (e.currentTarget as HTMLElement).classList.toggle('active');
      });
    });

    // Active toggle
    document.querySelectorAll('.active-toggle').forEach(toggle => {
      toggle.addEventListener('change', (e) => {
        const checkbox = e.target as HTMLInputElement;
        const id = checkbox.dataset.id;
        const label = checkbox.closest('.toggle')?.querySelector('.toggle-label');
        if (label) {
          label.textContent = checkbox.checked ? 'Active' : 'Hidden';
        }
        console.log(`Set insight ${id} active:`, checkbox.checked);
      });
    });

    // Toast notification helper
    function showToast(message: string, type: 'success' | 'error' = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Action buttons
    document.querySelectorAll('[data-action]').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const button = e.currentTarget as HTMLElement;
        const action = button.dataset.action;
        const id = button.dataset.id;

        switch (action) {
          case 'edit':
            window.location.href = `/blog/editor?id=${id}`;
            break;

          case 'unpublish':
            if (confirm('Are you sure you want to unpublish this post? It will be saved as a draft.')) {
              button.classList.add('loading');
              try {
                const response = await fetch(`/api/blog/${id}`, {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ status: 'draft' })
                });
                if (response.ok) {
                  showToast('Post unpublished successfully');
                  setTimeout(() => window.location.reload(), 1000);
                } else {
                  const error = await response.json();
                  showToast(error.error || 'Failed to unpublish', 'error');
                }
              } catch (err) {
                showToast('Failed to unpublish', 'error');
              }
              button.classList.remove('loading');
            }
            break;

          case 'publish':
            if (confirm('Are you sure you want to publish this draft?')) {
              button.classList.add('loading');
              try {
                const response = await fetch(`/api/blog/${id}`, {
                  method: 'PATCH',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ status: 'published' })
                });
                if (response.ok) {
                  showToast('Post published successfully');
                  setTimeout(() => window.location.reload(), 1000);
                } else {
                  const error = await response.json();
                  showToast(error.error || 'Failed to publish', 'error');
                }
              } catch (err) {
                showToast('Failed to publish', 'error');
              }
              button.classList.remove('loading');
            }
            break;

          case 'copy-link':
            const slug = button.dataset.slug;
            const status = button.dataset.status;
            const url = status === 'published'
              ? `${window.location.origin}/blog/${slug}`
              : `${window.location.origin}/blog/draft/${id}`;

            try {
              await navigator.clipboard.writeText(url);
              showToast('Link copied to clipboard');
            } catch (err) {
              // Fallback for older browsers
              const textArea = document.createElement('textarea');
              textArea.value = url;
              document.body.appendChild(textArea);
              textArea.select();
              document.execCommand('copy');
              document.body.removeChild(textArea);
              showToast('Link copied to clipboard');
            }
            break;

          case 'delete':
            const title = button.dataset.title;
            if (confirm(`Are you sure you want to permanently delete "${title}"? This cannot be undone.`)) {
              button.classList.add('loading');
              try {
                const response = await fetch(`/api/blog/${id}`, {
                  method: 'DELETE'
                });
                if (response.ok) {
                  showToast('Post deleted successfully');
                  // Remove the item from the UI
                  const item = button.closest('.insight-item');
                  item?.remove();

                  // Check if list is empty
                  const list = document.getElementById('insights-list');
                  if (list && list.children.length === 0) {
                    list.classList.add('hidden');
                    document.getElementById('empty-state')?.classList.remove('hidden');
                  }
                } else {
                  const error = await response.json();
                  showToast(error.error || 'Failed to delete', 'error');
                }
              } catch (err) {
                showToast('Failed to delete', 'error');
              }
              button.classList.remove('loading');
            }
            break;
        }
      });
    });

    // Drag & drop reordering
    let draggedElement: HTMLElement | null = null;

    document.querySelectorAll('.insight-item').forEach(item => {
      item.setAttribute('draggable', 'true');

      item.addEventListener('dragstart', (e) => {
        draggedElement = e.currentTarget as HTMLElement;
        draggedElement.classList.add('dragging');
      });

      item.addEventListener('dragend', (e) => {
        draggedElement?.classList.remove('dragging');
        draggedElement = null;
        updateCarouselOrder();
      });

      item.addEventListener('dragover', (e) => {
        e.preventDefault();
        const afterElement = getDragAfterElement(e.currentTarget as HTMLElement, e.clientY);
        const container = document.getElementById('insights-list');
        if (afterElement == null && container && draggedElement) {
          container.appendChild(draggedElement);
        } else if (container && draggedElement && afterElement) {
          container.insertBefore(draggedElement, afterElement);
        }
      });
    });

    function getDragAfterElement(container: HTMLElement, y: number) {
      const draggableElements = [...container.parentElement!.querySelectorAll('.insight-item:not(.dragging)')];

      return draggableElements.reduce((closest: any, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;

        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function updateCarouselOrder() {
      const items = document.querySelectorAll('.insight-item');
      const newOrder = Array.from(items).map((item, index) => ({
        id: (item as HTMLElement).dataset.id,
        order: index + 1
      }));
      console.log('New carousel order:', newOrder);
    }

    // Carousel settings
    document.getElementById('rotate-interval')?.addEventListener('change', (e) => {
      const value = (e.target as HTMLInputElement).value;
      console.log('Auto-rotate interval:', value, 'seconds');
    });

    document.getElementById('visible-count')?.addEventListener('change', (e) => {
      const value = (e.target as HTMLInputElement).value;
      console.log('Visible cards:', value);
    });
  </script>
</body>
</html>
