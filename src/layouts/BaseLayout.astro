---
import FeedbackWidget from '../components/FeedbackWidget.astro';
import CookieConsent from '../components/CookieConsent.astro';
import EditMode from '../components/EditMode.astro';
// ThemeSwitcher removed - using original theme only

interface Props {
  title: string;
  description?: string;
  image?: string; // OG image URL
  filePath?: string; // Path to source file for editing
}

const {
  title,
  description = "Customer-first airline retailing—dynamic offers, simplified orders, and payments that don't get in the way.",
  image = "/og-image.png",
  filePath
} = Astro.props;

// Canonical URL (always use root domain without theme prefix)
const canonicalURL = new URL(Astro.url.pathname.replace(/^\/(0|1|2)\//, '/'), 'https://retailaer.com').href;

// Theme mapping
const themeMap: Record<string, string> = {
  '0': 'current',
  '1': 'design-1',
  '2': 'design-2',
};

// Get theme from middleware locals first, fallback to URL parsing
let theme = Astro.locals.theme || '';
let themePrefix = Astro.locals.themePrefix || '';

// Fallback: Parse theme from original request URL if locals not set
if (!theme || theme === 'current') {
  // Try to get theme from the original URL (before any rewrites)
  const originalUrl = Astro.request.headers.get('x-original-url') || Astro.url.pathname;
  const pathParts = originalUrl.split('/').filter(Boolean);

  if (pathParts.length > 0 && themeMap[pathParts[0]]) {
    themePrefix = pathParts[0];
    theme = themeMap[themePrefix];
  } else {
    theme = 'current';
    themePrefix = '';
  }
}

const basePath = themePrefix ? `/${themePrefix}` : '';
---

<!DOCTYPE html>
<html lang="en" data-theme={theme}>
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-206SDTT0S9"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-206SDTT0S9');
  </script>

  <!-- LinkedIn Insight Tag - Get your Partner ID from LinkedIn Campaign Manager -->
  <!-- To enable: Replace YOUR_PARTNER_ID with your actual LinkedIn Partner ID -->
  <!-- <script type="text/javascript">
    _linkedin_partner_id = "YOUR_PARTNER_ID";
    window._linkedin_data_partner_ids = window._linkedin_data_partner_ids || [];
    window._linkedin_data_partner_ids.push(_linkedin_partner_id);
  </script>
  <script type="text/javascript">
    (function(l) {
      if (!l){window.lintrk = function(a,b){window.lintrk.q.push([a,b])};
      window.lintrk.q=[]}
      var s = document.getElementsByTagName("script")[0];
      var b = document.createElement("script");
      b.type = "text/javascript";b.async = true;
      b.src = "https://snap.licdn.com/li.lms-analytics/insight.min.js";
      s.parentNode.insertBefore(b, s);
    })(window.lintrk);
  </script>
  <noscript>
    <img height="1" width="1" style="display:none;" alt=""
      src="https://px.ads.linkedin.com/collect/?pid=YOUR_PARTNER_ID&fmt=gif" />
  </noscript> -->

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{title}</title>
  <meta name="description" content={description}>

  <!-- Canonical URL -->
  <link rel="canonical" href={canonicalURL} />

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content={canonicalURL} />
  <meta property="og:title" content={title} />
  <meta property="og:description" content={description} />
  <meta property="og:image" content={new URL(image, 'https://retailaer.com').href} />
  <meta property="og:site_name" content="Retailaer" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content={canonicalURL} />
  <meta name="twitter:title" content={title} />
  <meta name="twitter:description" content={description} />
  <meta name="twitter:image" content={new URL(image, 'https://retailaer.com').href} />

  <!-- Google Fonts - Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="/css/themes.css">
  <link rel="stylesheet" href="/css/design-system.css">
  <link rel="stylesheet" href="/css/figma-styles.css">
  <link rel="stylesheet" href="/css/homepage.css">

  <!-- Organization Schema -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "Retailaer",
    "url": "https://retailaer.com",
    "logo": "https://retailaer.com/retailaer-logo.svg",
    "description": "Customer-first Offer and Order Management platform for modern airline retailing. 204M+ orders processed.",
    "foundingDate": "2013",
    "email": "info@retailaer.com",
    "sameAs": [
      "https://www.linkedin.com/company/retailaer"
    ],
    "contactPoint": {
      "@type": "ContactPoint",
      "contactType": "sales",
      "email": "sales@retailaer.com"
    },
    "offers": {
      "@type": "Offer",
      "description": "Airline Offer and Order Management Platform",
      "category": "Software as a Service"
    }
  })} />

  <!-- WebSite Schema for search -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Retailaer",
    "url": "https://retailaer.com",
    "description": "Customer-first airline retailing platform"
  })} />
</head>
<body>
  <!-- Theme Switcher -->
  <!-- ThemeSwitcher removed -->

  <!-- Edit Mode Toolbar -->
  {filePath && <EditMode filePath={filePath} />}

  <!-- Navigation -->
  <nav class="navbar">
    <div class="container">
      <a href={`${basePath}/`} class="navbar-brand">
        <img src="/retailaer-logo-white.svg" alt="Retailaer" class="navbar-logo" />
      </a>

      <!-- Hamburger Menu Button -->
      <button class="mobile-menu-toggle" aria-label="Toggle menu" aria-expanded="false">
        <span></span>
        <span></span>
        <span></span>
      </button>

      <ul class="navbar-nav">
        <li><a href={`${basePath}/solutions`}>Solutions</a></li>
        <li><a href={`${basePath}/company`}>Company</a></li>
        <li><a href={`${basePath}/insights`}>Insights</a></li>
        <li><a href={`${basePath}/contact`}>Contact</a></li>
        <li><a href={`${basePath}/contact`} class="btn btn-primary">Get in Touch</a></li>
      </ul>
    </div>
  </nav>

  <slot />

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-grid">
        <div class="footer-col">
          <img src="/retailaer-logo-white.svg" alt="Retailaer" class="footer-logo" />
          <p class="text-white">Retailaer's Connect Retail Distribution platform and customer-first approach delivers benefits for airlines, its partners, and customers by consistently prioritising the needs and preferences of the customer throughout the offer, purchase, and post-sales process.</p>
        </div>
        <div class="footer-col">
          <h5>Connect Retail Distribution</h5>
          <ul>
            <li><a href={`${basePath}/solutions`}>Platform Overview</a></li>
            <li><a href={`${basePath}/solutions#distribution`}>Connect Retail Distribution</a></li>
            <li><a href={`${basePath}/solutions#travel-brands`}>For Travel Brands</a></li>
          </ul>
        </div>
        <div class="footer-col">
          <h5>Company</h5>
          <ul>
            <li><a href={`${basePath}/company`}>About Us</a></li>
            <li><a href={`${basePath}/insights`}>Insights</a></li>
            <li><a href={`${basePath}/faq`}>FAQ</a></li>
            <li><a href={`${basePath}/contact`}>Contact</a></li>
          </ul>
        </div>
        <div class="footer-col">
          <h5>Legal</h5>
          <ul>
            <li><a href={`${basePath}/privacy`}>Privacy Policy</a></li>
            <li><a href={`${basePath}/terms`}>Terms of Service</a></li>
            <li><a href={`${basePath}/cookies`}>Cookie Policy</a></li>
          </ul>
        </div>
        <div class="footer-col">
          <h5>Connect</h5>
          <ul>
            <li><a href="mailto:info@retailaer.com">info@retailaer.com</a></li>
          </ul>
        </div>
      </div>
      <div class="footer-bottom">
        <p>© {new Date().getFullYear()} Retailaer. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <FeedbackWidget />
  <CookieConsent />

  <script is:inline src="/css/figma-scripts.js"></script>
  <script is:inline src="/js/edit-mode-shortcut.js"></script>

  <!-- GA4 Event Tracking -->
  <script is:inline>
    // Track CTA button clicks
    document.querySelectorAll('.btn-primary, [href="/contact"]').forEach(function(btn) {
      btn.addEventListener('click', function() {
        if (typeof gtag !== 'undefined') {
          gtag('event', 'cta_click', {
            event_category: 'Engagement',
            event_label: this.textContent?.trim() || 'CTA Button',
            link_url: this.href || window.location.pathname
          });
        }
      });
    });

    // Track outbound links
    document.querySelectorAll('a[href^="mailto:"], a[href^="tel:"]').forEach(function(link) {
      link.addEventListener('click', function() {
        if (typeof gtag !== 'undefined') {
          gtag('event', 'contact_click', {
            event_category: 'Contact',
            event_label: this.href.replace('mailto:', '').replace('tel:', ''),
            link_type: this.href.startsWith('mailto:') ? 'email' : 'phone'
          });
        }
      });
    });

    // Track scroll depth
    var scrollDepths = [25, 50, 75, 100];
    var trackedDepths = [];

    window.addEventListener('scroll', function() {
      var scrollPercent = Math.round((window.scrollY + window.innerHeight) / document.body.scrollHeight * 100);

      scrollDepths.forEach(function(depth) {
        if (scrollPercent >= depth && trackedDepths.indexOf(depth) === -1) {
          trackedDepths.push(depth);
          if (typeof gtag !== 'undefined') {
            gtag('event', 'scroll_depth', {
              event_category: 'Engagement',
              event_label: depth + '%',
              value: depth
            });
          }
        }
      });
    });

    // Track navigation clicks
    document.querySelectorAll('.navbar-nav a').forEach(function(link) {
      link.addEventListener('click', function() {
        if (typeof gtag !== 'undefined') {
          gtag('event', 'navigation_click', {
            event_category: 'Navigation',
            event_label: this.textContent?.trim(),
            link_url: this.href
          });
        }
      });
    });
  </script>
</body>
</html>
